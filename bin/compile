#!/bin/bash
set -e

# Define directories
BUILDPACK_DIR=$(cd -P -- "$(dirname -- "$0")" && cd .. && pwd -P)
APP_CHECKOUT_DIR=$1
CACHE_DIR=$2
APP_SOURCE_DIR="${APP_CHECKOUT_DIR}"

# Check for Meteor app
if [ ! -d "$APP_SOURCE_DIR/.meteor" ]; then
  echo "FATAL: Can't find Meteor app."
  exit 1
fi

# Environment setup
export ROOT_URL=${ROOT_URL:-"http://localhost:3000"} # Set default ROOT_URL if not set

# Install Meteor
METEOR_DIR="$CACHE_DIR/meteor"
mkdir -p "$METEOR_DIR"
if [ ! -e "$METEOR_DIR/.meteor/meteor" ]; then
  curl -sS "https://install.meteor.com/" | HOME="$METEOR_DIR" /bin/sh
fi

function METEOR {
  HOME="$METEOR_DIR" "$METEOR_DIR/.meteor/meteor" "$@"
}

# Building Meteor app
cd "$APP_SOURCE_DIR"
echo "-----> Building Meteor app with ROOT_URL: $ROOT_URL"
BUNDLE_DEST=$(mktemp -d "$BUILDPACK_DIR/build-XXXX")
METEOR build --server $ROOT_URL --directory $BUNDLE_DEST --platforms web.browser

# Move built app
mv $BUNDLE_DEST/bundle "$APP_CHECKOUT_DIR/app"
rmdir $BUNDLE_DEST

echo "Meteor app build complete."
